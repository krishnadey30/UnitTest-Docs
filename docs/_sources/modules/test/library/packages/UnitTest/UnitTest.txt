.. default-domain:: chpl

.. module:: UnitTest
   :synopsis: Module UnitTest provides support for automated testing in Chapel.

UnitTest
========
**Usage**

.. code-block:: chapel

   use UnitTest;


Module UnitTest provides support for automated testing in Chapel.
Any function of the form

.. code-block:: chapel
  
  proc funcName(test: Test) throws {}

is treated as a test function. These functions must accept an object of Test
Class. We use :proc:`~UnitTest.runTest` to pass the tests.

**Example**

*Using Asserts*

:proc:`~Test.skip`
:proc:`~Test.skipIf`
:proc:`~Test.assertTrue`
:proc:`~Test.assertFalse`
:proc:`~Test.assertEqual`
:proc:`~Test.assertNotEqual`
:proc:`~Test.assertGreaterThan`
:proc:`~Test.assertLessThan`

.. code-block:: chapel

   use UnitTest;
    
   // calculates factorial
   proc factorial(x: int): int {
     return if x == 0 then 1 else x * factorial(x-1); 
   }

   proc test1(test: Test) throws {
     test.skipIf(factorial(0) != 1,"Base condtion is wrong in factorial");
     test.assertTrue(factorial(5) == 120);
   }

   UnitTest.runTest(test1);

Another Example

.. code-block:: chapel

   use UnitTest;
    
   proc celius2fahrenheit(x) {
     return (x * 9/5)+32;
     // we should be returning "(x: real * 9/5)+32"
   }

   proc test_temperature(test: Test) throws {
     test.assertFalse(celius2fahrenheit(37) == 98);
     // we were expecting 98.6 but since we missed typecasting
     // the above function returned 98.
   }

   UnitTest.runTest(test_temperature);

Output: 

.. code-block:: bash
  
  ======================================================================
  FAIL xyz.chpl: test_temperature()
  ----------------------------------------------------------------------
  AssertionError: assertFalse failed. Given expression is True

  ----------------------------------------------------------------------
  Run 1 test

  FAILED failures = 1 


*Specifying locales*

:proc:`~Test.addNumLocales`
:proc:`~Test.maxLocales`
:proc:`~Test.minLocales`

.. code-block:: chapel

   proc test2(test: Test) throws {
     test.addNumLocales(16);
   }

   proc test3(test: Test) throws {
     test.addNumLocales(16,8);
   }
  
   proc test4(test: Test) throws {
     test.maxLocales(4);
     test.minLocales(2);
   }

*Specifying Dependencies*

:proc:`~Test.dependsOn`

.. code-block:: chapel

   use UnitTest;
    
   var factArray: [1..0] int;

   // calculates factorial
   proc factorial(x: int): int {
     return if x == 0 then 1 else x * factorial(x-1); 
   }

   proc testFillFact(test: Test) throws {
     test.skipIf(factorial(0) != 1,"Base condtion is wrong in factorial");
     for i in 1..10 do
       factArray.push_back(factorial(i));
   }

   proc testSumFact(test: Test) throws {
     test.dependsOn(testFillFact);
     var s = 0;
     for i in 1..10 do
       s += factArray[i];
     test.assertGreaterThan(s,0); 
   }

   UnitTest.runTest(testSumFact, testFillFact);


.. class:: Test

   .. method:: proc skip(reason: string = "") throws

      Unconditionally skip a test.
      
      :arg reason: the reason for skipping
      :type reason: `string` 
      

   .. method:: proc skipIf(condition: bool, reason: string = "") throws

      
      Skip a test if the condition is true.
      
      :arg condition: the boolean condition
      :type condition: `bool`
      
      :arg reason: the reason for skipping
      :type reason: `string`
      

   .. method:: proc assertTrue(test: bool) throws

      
      Assert that a boolean condition is true.  If it is false, prints
      ``assert failed`` and raises AssertionError. 
      
      :arg test: the boolean condition
      :type test: `bool`
      

   .. method:: proc assertFalse(test: bool) throws

      
      Assert that a boolean condition is false.  If it is true, prints
      ``assert failed`` and raises AssertionError.
      
      :arg test: the boolean condition
      :type test: `bool`
      

   .. method:: proc assertEqual(first, second) throws

      
      Fail if the two objects are unequal as determined by the ``==`` operator.
      
      :arg first: The first object to compare.
      :arg second: The second object to compare. 
      

   .. method:: proc assertNotEqual(first, second) throws

      
      Assert that a first argument is not equal to second argument. If it is false, 
      raises AssertionError. Uses ``==`` operator and type to determine if both are equal
      or not.
      
      :arg first: The first object to compare.
      :arg second: The second object to compare. 
      

   .. method:: proc assertGreaterThan(first, second) throws

      
      Assert that a first argument is greater than second argument.  If it is false, prints
      ``assert failed`` and raises AssertionError. 
      
      :arg first: The first object to compare.
      :arg second: The second object to compare. 
      

   .. method:: proc assertLessThan(first, second) throws

      
      Assert that a first argument is less than second argument.  If it is false, raises AssertionError. 
      
      :arg first: The first object to compare.
      :arg second: The second object to compare. 
      

   .. method:: proc maxLocales(value: int) throws

      
      Specify Max Number of Locales required to run the test
      
      :arg value: Maximum number of locales with which the test can be ran.
      :type value: `int`.
      
      :throws UnexpectedLocalesError: If `value` is less than 1 or `minNumLocales` 
      

   .. method:: proc minLocales(value: int) throws

      
      Specify Min Number of Locales required to run the test
      
      :arg value: Minimum number of locales with which the test can be ran.
      :type value: `int`.
      
      :throws UnexpectedLocalesError: If `value` is more than `maxNumLocales`
      

   .. method:: proc addNumLocales(locales: int ...?n) throws

      
      To add locales in which test can be run.
      
      :arg locales: Multiple ``,`` separated locale values
      
      :throws UnexpectedLocalesError: If `locales` are already added.
      
      

   .. method:: proc dependsOn(tests: argType ...?n) throws

      Adds the tests in which the given test is depending.
      
      :arg tests: Multiple ``,`` separated First Class Test Functions.
      
      

.. function:: proc runTest(tests: argType ...?n) throws

   Runs the tests
   
   :arg tests: Multiple ``,`` separated First Class Test Functions.
   
   Call this as 
   
   .. code-block:: chapel
   
     UnitTest.runTest(test1, test2);
   

